<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bad Apple!! in working JavaScript</title>
    <style>
        body {
            background-color: rgb(60, 60, 60);
            color: white;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
        }

        textarea {
            background-color: black;
            color: white;
            font-size: 100%;
            text-align: center;
            border: none;
            resize: none;
            outline: none;
            overflow: hidden;
            white-space: pre;
            overflow-y: hidden;
            overflow-x: hidden;
            border-radius: 10px;
            padding: 5px;
            user-select: none;
            margin-top: 10px;
        }

        #render {
            display: none;
        }

        #ctrl {
            margin-top: -25px;
        }
    </style>
</head>

<body>
    <video id="video" src="bad_apple.mp4" type="video/mp4" style="display:none"></video>
    <textarea id="screen" readonly></textarea><br /><br />
    <div id="ctrl">
        <button id="copy">Copy JS</button>
        <button id="player">Play</button>
    </div>
    <canvas id="render"></canvas>
    <script>
        const video = document.getElementById('video');
        const screen = document.getElementById('screen');
        const copy = document.getElementById('copy');
        const canvas = document.getElementById('render');
        const ctx = canvas.getContext('2d');
        screen.style="height: 525px; width: 691px;";
        screen.value=`Made by WojtekGame, 2024
                                     =@#(=[%(                                      
                                    @>      ~@                                     
                                    #@@-     *@                                    
                                     :@@@    *@                                    
                              *@@@@[     @   @<%@^                                 
                        ^@@%#{           {% @~   *%@%.                             
                    .%@%                              @@@{                         
                  :@]                                     *@@#:                    
                 %}                                           (@#                  
                }[                                               {)                
               [#                                                 )#               
               @      +@[        =         \\  /\\  /                    %:              
              ~{     <{ *@.     }@=         \\/\  \\/                      @              
              =[     @   [*     @@@.(#   }     %     =              *#             
              =[     @    %:   @@}-@@%}(@{  +#%@@:   %*              #             
              =[     @     [} <@@         <@%@@%@    ]@-             }~            
              }(     @    __ @@@>               @     #@*             @            
             <#      @  @[=]%^):         -@#-   @     .@@             @            
             ))      @ +[    #)        {}   ~@  %~     %@@:           %:           
             ))      @        (       @=      @  @      @@@ (@  {)    )]           
              @      @                [:      *  @.     +@@[ {+  @    .{           
              @      @        @((((]@^           (]     ~@@@  @   @   :{           
              =[ %]  %@       %     @^           *#      @@@@<%@>(@@. {^           
               @}  @<+@%:     #%__(@#            ~#      @*-{{                     
                    ^#   %@#+                  [%@%      [^                        
                             +@%{]]]]]]#%%%%@@@+  ^{ %@[ [^                        
                             <@=  =@@@@}    +@@=   @%  =@@^                        
                            <%       []     #@@@<=       }^                        
                            @       <@@{)   @@@@@@@@@@#^-                          
                           }~    ^%       >@@@@@@@@@@@@@@@@@@}^                    
                           {~   })                 =+]@@@@@@%  :(@-                
                           @    @~                     ^          (@               
                           @    {>                   {}            <#              
                           @     @)                  @              @              `
        let mediaRecorder;
        let recordedChunks = [];
        let videoWidth, videoHeight;
        let usedNames = []
        let name = "Bad Apple!!";
        let nl = 0;
        function play() {
            video.play();
            player.innerText = "Pause";
            function exec() {
                if (!video.paused && !video.ended) {
                    processFrame();
                    screen.style.height = "1px";
                    screen.style.height = (screen.scrollHeight - 25) + "px";
                    screen.style.width = "1px";
                    screen.style.width = (screen.scrollWidth) + "px";
                }
                else if (video.ended) {
                    screen.value = "\"Bad Apple!!\""
                }
                window.requestAnimationFrame(exec);
            }
            requestAnimationFrame(exec);
        }
        document.addEventListener('click', () => play(), { once: true });

        copy.addEventListener('click', () => {
            if (!video.ended) navigator.clipboard.writeText(screen.value)
        });
        let player = document.getElementById('player');
        player.addEventListener('click', () => {
            if (video.paused) {
                video.play();
                player.innerText = "Pause";
            } else {
                video.pause();
                player.innerText = "Play";
            }
        }, false);
        video.addEventListener('loadedmetadata', () => {
            videoWidth = Math.floor(video.videoWidth / 5);
            videoHeight = Math.floor((video.videoHeight / 5) - 3);
            screen.style.width = videoWidth;
            screen.style.height = videoHeight * 2;
            canvas.width = videoWidth;
            canvas.height = videoHeight;
        });
        let asciiArt = '';
        let jsSnippets = [
            'const [r]=()=>{return"[a]"};console.log([a]())_',
            'let [r]=()=>{return"[a]"};console.log([a]())_',
            'const [r]=()=>{return"[a]"}_',
            'const [r]=()=>{return}_',
            'const [r]={}_',
            'const [r]=""_',
            'let [r]=()=>{return"[a]"}_',
            'let [r]=()=>{return}_',
            'let [r]={}_',
            'let [r]=""_',
            'console.log("[r]")_',
            'alert("[r]")_',
            'navigator.clipboard_',
            'document.body_',
            'document.body.style_',
            'document.body_',
            'navigator_',
            'document_',
            'console_'
        ];

        function processFrame() {
            if (Math.random() > 0) jsSnippets = jsSnippets.sort((a, b) => b.length - a.length);
            else jsSnippets = jsSnippets.sort((a, b) => a.length - b.length);
            ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
            const frameData = ctx.getImageData(0, 0, videoWidth, videoHeight);
            const asciiArt = convertToASCII(frameData);
            screen.value = asciiArt;
        }


        function replaceSpacesWithJSDoc(spaces) {
            if (spaces.length <= 4) return spaces;
            return '/*' + ' '.repeat(spaces.length - 4) + '*/';
        }

        function n() {
            const chars = "qwertyuiopasfgghjklzxcvbnmQWERTYUIOPASFGHJKLZXCVBNM_";
            let name = '';
            for (let i = 0; i < 3; i++)
                name += chars[Math.floor(Math.random() * chars.length)];

            //name = chars[Math.floor(Math.random() * chars.length)];
            //name += chars[Math.floor(Math.random() * chars.length)];
            //if (asciiArt.includes(name)) asciiArt.replaceAll(name, n);
            usedNames.push(name)
            if (usedNames.includes(name)) asciiArt.replaceAll(name, n);
            return name;
        }

        function add() {
            const l = ["canvas", "video", "body", "h1", "h2", "textarea", "h3", "p", "svg", "i", "b"];
            for (let i = 0; i < l.length; i++) {
                jsSnippets.push('const [r]=document.createElement("' + l[i] + '")_');
                jsSnippets.push('let [r]=document.createElement("' + l[i] + '")_');

            }
        }
        add();
        function convertToJS(asciiLine) {
            let st = asciiLine;
            jsSnippets.forEach(snippet => {
                const snippetLength = snippet.length;
                const hashSequence = '#'.repeat(snippetLength);
                const regex = new RegExp(hashSequence, 'g');
                st = st.replace(regex, snippet);
                st = st.replace(/\[r\]/g, n);
                st = st.replace(/\[a\]/g, usedNames[usedNames.length - 1]);
                st = st.replace(/\[r\]/g + "()", usedNames[1 - usedNames.length] + "()");
            });

            st = st.replace(/#/g, ';');
            jsSnippets.forEach(snippet => {
                const snippetLength = snippet.length;
                const hashSequence = ';'.repeat(snippetLength);
                const regex = new RegExp(hashSequence, 'g');
                st = st.replace(regex, snippet);
                st = st.replace(/\[r\]/g, n);
                st = st.replace(/\[a\]/g, usedNames[usedNames.length - 1]);
                st = st.replace(/\[r\]/g + "()", usedNames[1 - usedNames.length] + "()");
            });
            st = st.replaceAll("_", ";");
            st = st.replace("; ", ";");
            st = st.replace("*/ ", "*/");
            st = st.replace(/\s+/g, replaceSpacesWithJSDoc);
            usedNames = [];
            return st;
        }

        function convertToASCII(imageData) {
            asciiArt = '';
            const { data, width, height } = imageData;
            let asciiLine = '';

            const asciiChars = [' ', '#'];
            for (let y = 0; y < height; y += 2) {
                for (let x = 0; x < width; x++) {
                    const offset = (y * width + x) * 4;
                    const rgb = [data[offset], data[offset + 1], data[offset + 2]];
                    const brightness = (rgb[0] + rgb[1] + rgb[2]) / 3;
                    const charIndex = Math.floor((brightness / 255) * (asciiChars.length - 1));
                    asciiLine += asciiChars[charIndex];
                }
                asciiArt += convertToJS(asciiLine) + '\n';
                asciiLine = '';
            }
            return asciiArt;
        }
    </script>
</body>

</html>
